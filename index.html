<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Read Thumbnail from EXIF</title>
<style>
  * {
    -webkit-box-sizing: border-box;
       -moz-box-sizing: border-box;
            box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
    body {
      display: inline-block;
      text-align: center;
      width: 100%;
  }
  form {
    height: 80px;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #f1f1f1;
      margin-bottom: 20px;
  }
  img {
    vertical-align: middle;
    margin: 5px;
    border-radius: 6px;
    box-shadow: 0px 0px 5px #cccccc;
    position: relative;
    font-family: 'system-ui';
    overflow: hidden;
  }

  img:before { 
    content: "\01F494" "\00000a" attr(title);
    font-size: 16px;
    font-family: "system-ui";
    color: #606060;
    color: #00000080;
    display: flex;
    position: absolute;
    z-index: 2;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #eee;
    justify-content: center;
    align-items: center;
    white-space: pre;
  }



  
</style>
</head>
<body>

  <form>
    <input type="file" multiple>
  </form>

  <section id="container"></section>

  <template id="imageTemplate">
    <img src="${src}" width="${width}" height="${height}" title="${title}">
  </template>



<script>
  document.querySelector('input').addEventListener('change', async (e)=>{
    e.stopPropagation();
    e.preventDefault();
    const target = e.target || e.dataTransfer ;
    const files = target && target.files;
    console.time('Total Time ------->');

    let container = document.getElementById("container");
    let template = document.getElementById("imageTemplate").innerHTML;
    container.innerText ='';
    let templateContent ='';

    let maxStartIndex = maxEndIndex = 0;

    // for (let index = 0; index < 100; index++) { // Performance test
          for(let file of files){
            var response = await getThumb(file);

            maxStartIndex = Math.max(response.start, maxStartIndex);
            maxEndIndex = Math.max(response.end, maxEndIndex);
            
            variaveis = {
              fileName: response.fileName, 
              title: response.fileName,
              src: response.body, 
              width: response.width,
              height: response.height,
            }

            if (!response.ok) {
              console.error('erro', response);
              let title = response.statusText + '\n\n' + response.fileName;
              variaveis = {...variaveis, title: title, src: '', width: 240, height: 180 }
            }
            // templateContent += templateApply(template, variaveis);
            templateContent = templateApply(template, variaveis);
            container.insertAdjacentHTML( 'beforeend', templateContent );
          } //endFor
    // } // endFor Performance test
    
    // container.insertAdjacentHTML( 'beforeend', templateContent );
    console.log('maxStartIndex', maxStartIndex, 'maxEndIndex', maxEndIndex);
    console.timeEnd('Total Time ------->');
  });

  let templateApply = (tpl, args) => tpl.replace(/\${(\w+)}/g, (_, v) => { return args[v] || '' });









  async function getThumb(file) {
    responseThumbSizes = {};
    responseThumb = await getThumbFind(file);
    
    if (responseThumb.ok) {
      responseThumbSizes = await getThumbSizes(responseThumb.body);
    }
    return {...responseThumb, ...responseThumbSizes};
  } //getThumb


  function getThumbFind(file) {
    return new Promise((resolve, reject) => {

      if (file.type !== "image/jpeg") { 
        reject({ok:false, statusText: 'Invalid image/jpeg', fileName: file.name}); 
      };

      const reader = new FileReader();
      reader.readAsArrayBuffer(file.slice(0, 50000));
      reader.onload = (fileSlice)=>{
        response = findBlob(fileSlice, file.name);
        resolve(response);
      };
      
    });
  } //getThumbFind


  function findBlob(filePart, fileName) {
    var array = new Uint8Array(filePart.target.result);
    
    [start, end] = findStartEnd(array);
    
    if (start && end) {
      var urlCreator = window.URL || window.webkitURL;
      var thumb = new Blob([array.subarray(start, end)], {type:"image/jpeg"});
      var imageBlobUrl = urlCreator.createObjectURL(thumb);
      
      return {ok:true, statusText: 'ok', body: imageBlobUrl, fileName: fileName, start: start, end: end};
      // return {ok:true, statusText: 'ok', body: imageBlobUrl, fileName: fileName};

    } else {
      // return {ok:false, statusText: 'Thumbnail not found', fileName: fileName, start: start, end: end};
      return {ok:false, statusText: 'Thumbnail not found!', fileName: fileName};
    }

  } //findBlob


  function findStartEnd(array) {
    var start = false, end = false;
    var x = array.length;
    for (var i = 2; i < x; i++) {
      if (array[i] === 0xFF) {
        
          if ( array[i + 1] === 0xD8) {
            // console.log('START ', array[i], array[i+1], i);
            start = i;
          }

          else if (start && array[i + 1] === 0xD9) {
            // console.log('END ', array[i], array[i+1], i);
            end = i+2 ;
            break;
          }

      }
    }
    // console.log('start', start, 'end', end);
    return [start, end];
  } //findStartEnd


  function getThumbSizes(blobImg) {
    return new Promise((resolve, reject) => {
      var width, height;
      var img = new Image();
      img.src = blobImg;
      img.onload = function() {
        width = this.width;
        height = this.height;
        // console.log(width, height);
        resolve({width: width, height: height});
      }
      img.onerror = function(error) { 
        resolve({ok:false, statusText: 'Thumbnail not found!'});
      }
    });
  } // getThumbSizes



</script>
</body>
</html>
